export const build=(e,{pushFocus:t,pushNamespace:r,buildDi:i}={})=>{let n,o,s=[],a="root",p=[a],$=[{[a]:{}}],c=[{[a]:{}}],u=(e,t)=>"@"===e[0]?t?.[e.slice(1)]:e,f=(e,t)=>void 0===t?e:t,h=(e,t,r)=>t?e[0][p[0]][t]=r:e[0][p[0]]=r,l=e=>{[$,c].forEach(t=>{t[0][p[0]][e]||h(t,e,{}),t.unshift(t[0][p[0]])}),p.unshift(e)},d=(e,t,{curriedDi:r,di:i,props:n}={})=>{let o=i&&i(c[0][p[0]]);return r&&(t=t(o)),(i,s)=>{let a=s?.constructor===Object?{...n,...s}:s,p=e.reduce((e,t)=>(e.unshift(e.length?[e[0][0][e[0][1]]||("@"===t[0]?[]:{}),u(t,a)]:[i||{},t]),e),[]),$=p.length?p[0][0][p[0][1]]:i,c=t($,r||!o||a===s?a:{...o,...a}),f=Array.isArray(c)?c[0]:c;if("function"==typeof f)return c;let h=f===$?i:p.reduce((e,[t,r])=>Array.isArray(t)?t.map((t,i)=>i===r?e:t):{...t,[r]:e},f);return Array.isArray(c)?(c[0]=h,c):h}},g=(e,t,{curriedDi:r,di:n,subState:s=e=>e,props:a}={})=>{let f=n&&n({...i,views:$[0][p[0]],actions:c[0][p[0]]});return r&&(t=t(f)),(i,n)=>{let p={...a,...i},$=e.reduce((e,t)=>e?.[u(t,p)],o);return t(s($),r||!f?p:{...f,...p},n)}},w=(e,t,...r)=>{if(!Number.isInteger(e)||e<1)throw Error(`'count' must be integer bigger then 0, but '${e}' provided`);if(!Number.isInteger(t)||e<0)throw Error(`'keep' must be integer bigger or equeal 0, but '${t}' provided`);r.forEach(r=>{if(!Array.isArray(r))throw Error(`Stack operations can be performend on Array only, '${r}' provided`);if(e>r.length-t)throw Error(`Cannot pop '${e}' item(s) from stack with depth '${r.length} and keep '${t}' item(s)`);r.splice(0,e)})},m={Context({pushFocus:e,pushNamespace:t,popFocus:r,popNamespace:i}){i&&w(i,1,$,c,p),t&&(Array.isArray(t)?t.map(l):l(t)),r&&w(r,0,s),e&&(Array.isArray(e)?s.push(...e):s.push(e))},Action:(e,{name:t,...r}={})=>h(c,f(e.name,t),d([...s],e,r)),Actions:(e,{name:t,...r}={})=>e.forEach(e=>m.Action(e,r)),View:(e,{name:t,...r}={})=>h($,f(e.name,t),g([...s],e,r)),MainView:(e,t)=>n=g([...s],e,t),Include:e=>e.forEach(([e,t,r])=>y(e,r,t,r))},y=(e,{pushFocus:t,pushNamespace:r}={},...i)=>{let n=m[e];if("function"!=typeof n)throw Error(`Unrecognized operation: ${e}`);m.Context({pushFocus:t,pushNamespace:r}),n(...i);let o=e=>e&&(Array.isArray(e)?e.length:1);m.Context({popFocus:o(t),popNamespace:o(r)})};if(y("Include",{pushFocus:t,pushNamespace:r},e),"function"!=typeof n)throw Error("The main view is not defined, please use 'MainView' to define it");return{view:e=>(o=e,n()),actions:c.at(-1)[p.at(-1)]}}